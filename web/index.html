<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="password-save" content="no">
  <meta name="autocomplete" content="off">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="format-detection" content="telephone=no">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="progresso">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>progresso</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <script>
    // Disable the browser's default context menu so only the app's menu shows
    window.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });
    
    // Simple password manager prevention using CSS and minimal JavaScript
    document.addEventListener('DOMContentLoaded', function() {
      // Add CSS to disable autocomplete
      const style = document.createElement('style');
      style.textContent = `
        input[type="text"], input[type="password"], input[type="email"], input[type="number"] {
          autocomplete: off !important;
        }
        input:-webkit-autofill {
          -webkit-box-shadow: 0 0 0 1000px white inset !important;
        }
        [contenteditable="true"], .ql-editor {
          autocomplete: off !important;
          autocorrect: off !important;
          autocapitalize: off !important;
          spellcheck: false !important;
        }
      `;
      document.head.appendChild(style);
      
      // Set autocomplete=off on dynamically created elements
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) { // Element node
              // Handle input elements
              const inputs = node.querySelectorAll ? node.querySelectorAll('input, textarea') : [];
              inputs.forEach(function(input) {
                if (input.type !== 'hidden') {
                  input.setAttribute('autocomplete', 'off');
                }
              });
              
              // Handle contenteditable elements
              const editables = node.querySelectorAll ? node.querySelectorAll('[contenteditable="true"], .ql-editor') : [];
              editables.forEach(function(editable) {
                editable.setAttribute('autocomplete', 'off');
                editable.setAttribute('spellcheck', 'false');
              });
              
              // Check if the node itself is an input or contenteditable
              if (node.tagName === 'INPUT' && node.type !== 'hidden') {
                node.setAttribute('autocomplete', 'off');
              }
              
              if (node.contentEditable === 'true' || (node.classList && node.classList.contains('ql-editor'))) {
                node.setAttribute('autocomplete', 'off');
                node.setAttribute('spellcheck', 'false');
              }
            }
          });
        });
      });
      
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    });
    
    // Simplified function for log action page
    window.preventPasswordManagerOnLogPage = function() {
      setTimeout(function() {
        document.querySelectorAll('input, textarea, [contenteditable], .ql-editor').forEach(function(el) {
          if (el.type !== 'hidden') {
            el.setAttribute('autocomplete', 'off');
            el.setAttribute('spellcheck', 'false');
          }
        });
      }, 100);
    };
    
    // Custom file picker for image uploads
    window.customFilePicker = function() {
      return new Promise((resolve) => {
        let isResolved = false;
        
        // Prefer File System Access API when available
        if (window.showOpenFilePicker) {
          (async () => {
            try {
              const handles = await window.showOpenFilePicker({
                multiple: false,
                excludeAcceptAllOption: true,
                types: [{
                  description: 'Images',
                  accept: { 'image/*': ['.png', '.jpg', '.jpeg', '.gif', '.webp'] }
                }]
              });
              
              if (!handles || !handles.length) {
                if (!isResolved) { isResolved = true; resolve(null); }
                return;
              }
              
              const file = await handles[0].getFile();
              const reader = new FileReader();
              reader.onload = function(event) {
                if (!isResolved) {
                  isResolved = true;
                  resolve({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    dataUrl: event.target.result
                  });
                }
              };
              reader.onerror = function() {
                if (!isResolved) { isResolved = true; resolve(null); }
              };
              reader.readAsDataURL(file);
            } catch (e) {
              // Fall back to input method
              startInputFallback();
            }
          })();
          return;
        }

        // Fallback: hidden input method
        function startInputFallback() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.style.display = 'none';
          input.setAttribute('autocomplete', 'off');

          let isCleanedUp = false;
          const cleanup = () => {
            if (!isCleanedUp && input.parentNode) {
              input.parentNode.removeChild(input);
              isCleanedUp = true;
            }
          };

          input.addEventListener('change', function(e) {
            if (isResolved) return;
            isResolved = true;

            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(event) {
                resolve({
                  name: file.name,
                  size: file.size,
                  type: file.type,
                  dataUrl: event.target.result
                });
                cleanup();
              };
              reader.onerror = function() {
                resolve(null);
                cleanup();
              };
              reader.readAsDataURL(file);
            } else {
              resolve(null);
              cleanup();
            }
          }, { once: true });

          document.body.appendChild(input);
          input.click();

          // Cleanup on timeout
          setTimeout(() => {
            if (!isResolved) {
              isResolved = true;
              resolve(null);
              cleanup();
            }
          }, 30000);
        }

        if (!window.showOpenFilePicker) {
          startInputFallback();
        }
      });
    };

    // For login pages - enable password manager when needed
    window.enablePasswordManagerForLogin = function(email, password) {
      if (!email || !password) return;
      
      try {
        const form = document.createElement('form');
        form.style.position = 'absolute';
        form.style.left = '-9999px';
        form.style.top = '-9999px';
        form.setAttribute('autocomplete', 'on');

        const user = document.createElement('input');
        user.type = 'text';
        user.name = 'username';
        user.autocomplete = 'username';
        user.value = email;

        const pass = document.createElement('input');
        pass.type = 'password';
        pass.name = 'password';
        pass.autocomplete = 'current-password';
        pass.value = password;

        const submit = document.createElement('input');
        submit.type = 'submit';

        form.appendChild(user);
        form.appendChild(pass);
        form.appendChild(submit);
        document.body.appendChild(form);

        form.requestSubmit(submit);

        setTimeout(() => {
          if (form.parentNode) form.parentNode.removeChild(form);
        }, 250);
      } catch (_) {}
    };
  </script>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
